<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Horse Racer AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .header { margin-bottom: 30px; }
        .status-badge { font-size: 0.85em; }
        .invite-btn { font-size: 0.85em; }
        .table-responsive { max-height: 600px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèá Horse Racer AI - Admin Dashboard</h1>
            <p class="text-muted">Manage beta signups and send TestFlight invitations</p>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h3 id="totalSignups" class="mb-0">0</h3>
                        <p class="text-muted mb-0">Total Signups</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h3 id="pendingSignups" class="mb-0">0</h3>
                        <p class="text-muted mb-0">Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h3 id="invitedSignups" class="mb-0">0</h3>
                        <p class="text-muted mb-0">Invited</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-body text-center">
                        <h3 id="totalEmails" class="mb-0">0</h3>
                        <p class="text-muted mb-0">Emails Sent</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Beta Signups</h5>
                <button class="btn btn-sm btn-primary" onclick="refreshData()">üîÑ Refresh</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Device</th>
                                <th>Experience</th>
                                <th>Signed Up</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="signupsTable">
                            <tr>
                                <td colspan="8" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Email Logs</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>To</th>
                                <th>Subject</th>
                                <th>Template</th>
                                <th>Sent At</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable">
                            <tr>
                                <td colspan="6" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Invite Modal -->
    <div class="modal fade" id="inviteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send TestFlight Invite</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="inviteForm">
                        <input type="hidden" id="signupId" name="signupId">
                        <div class="mb-3">
                            <label class="form-label">Recipient</label>
                            <input type="text" class="form-control" id="recipientName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">TestFlight Link *</label>
                            <input type="url" class="form-control" id="testflightLink" name="testflightLink" 
                                   placeholder="https://testflight.apple.com/join/xxxxx" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Invite Code (optional)</label>
                            <input type="text" class="form-control" id="inviteCode" name="inviteCode" 
                                   placeholder="BETA123456">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendInvite()">Send Invite</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:3001/api';
        let currentSignups = [];
        let inviteModal;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            inviteModal = new bootstrap.Modal(document.getElementById('inviteModal'));
            refreshData();
            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
        });

        // Refresh all data
        async function refreshData() {
            await Promise.all([loadSignups(), loadLogs()]);
        }

        // Load signups
        async function loadSignups() {
            try {
                const response = await fetch(`${API_BASE}/signups`);
                const signups = await response.json();
                currentSignups = signups;

                // Update stats
                document.getElementById('totalSignups').textContent = signups.length;
                document.getElementById('pendingSignups').textContent = signups.filter(s => s.status === 'pending').length;
                document.getElementById('invitedSignups').textContent = signups.filter(s => s.status === 'invited').length;

                // Update table
                const tbody = document.getElementById('signupsTable');
                if (signups.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No signups yet</td></tr>';
                    return;
                }

                tbody.innerHTML = signups.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.email}</td>
                        <td>${s.device}</td>
                        <td>${s.experience}</td>
                        <td>${new Date(s.timestamp).toLocaleDateString()}</td>
                        <td>
                            <span class="badge status-badge ${s.status === 'invited' ? 'bg-success' : 'bg-warning'}">
                                ${s.status}
                            </span>
                        </td>
                        <td>
                            ${s.inviteSent 
                                ? `<small class="text-muted">Sent ${new Date(s.inviteSentAt).toLocaleDateString()}</small>`
                                : `<button class="btn btn-sm btn-primary invite-btn" onclick="openInviteModal(${s.id})">
                                    üìß Send Invite
                                   </button>`
                            }
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Error loading signups:', err);
                document.getElementById('signupsTable').innerHTML = 
                    '<tr><td colspan="8" class="text-center text-danger">Error loading signups</td></tr>';
            }
        }

        // Load email logs
        async function loadLogs() {
            try {
                const response = await fetch(`${API_BASE}/logs`);
                const logs = await response.json();

                document.getElementById('totalEmails').textContent = logs.length;

                const tbody = document.getElementById('logsTable');
                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No emails sent yet</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.slice(-20).reverse().map(log => `
                    <tr>
                        <td>${log.id}</td>
                        <td>${log.to}</td>
                        <td>${log.subject}</td>
                        <td><code>${log.template}</code></td>
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td><span class="badge bg-success">${log.status}</span></td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Error loading logs:', err);
                document.getElementById('logsTable').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading logs</td></tr>';
            }
        }

        // Open invite modal
        function openInviteModal(signupId) {
            const signup = currentSignups.find(s => s.id === signupId);
            if (!signup) return;

            document.getElementById('signupId').value = signup.id;
            document.getElementById('recipientName').value = `${signup.name} (${signup.email})`;
            document.getElementById('testflightLink').value = '';
            document.getElementById('inviteCode').value = '';

            inviteModal.show();
        }

        // Send TestFlight invite
        async function sendInvite() {
            const signupId = parseInt(document.getElementById('signupId').value);
            const testflightLink = document.getElementById('testflightLink').value;
            const inviteCode = document.getElementById('inviteCode').value;

            if (!testflightLink) {
                alert('Please enter a TestFlight link');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/send-invite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signupId, testflightLink, inviteCode })
                });

                const result = await response.json();

                if (response.ok) {
                    alert('‚úÖ TestFlight invite sent successfully!');
                    inviteModal.hide();
                    await refreshData();
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (err) {
                console.error('Error sending invite:', err);
                alert('‚ùå Error sending invite. Check console for details.');
            }
        }
    </script>
</body>
</html>
